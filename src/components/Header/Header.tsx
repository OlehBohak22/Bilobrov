import { Layout } from "../Layout/Layout";
import s from "./Header.module.css";
import { HeaderUserSettings } from "../HeaderUserSettings/HeaderUserSettings";
import { Link } from "react-router";
import { useLocation } from "react-router";
import { useSelector } from "react-redux";
import { RootState } from "../../store";
import { buildMenuTree } from "../../utils/buildMenuTree";

interface HeaderProps {
  openRegister: () => void;
  openWishList: () => void;
  openCart: () => void;
  openMenu: () => void;
}

export const Header: React.FC<HeaderProps> = ({
  openRegister,
  openWishList,
  openCart,
  openMenu,
}) => {
  const location = useLocation();

  const menu = useSelector(
    (state: RootState) => state.menu.mainMenu?.items || []
  );

  const menuTree = buildMenuTree(menu);

  return (
    <header
      className={`${s.header} ${
        location.pathname.startsWith("/product/") ||
        location.pathname.startsWith("/catalog/") ||
        [
          "/about",
          "/account",
          "/support",
          "/podarunkovi-sertyfikaty-20",
          "/catalog",
          "/brendy",
        ].includes(location.pathname)
          ? s.hovered
          : ""
      } ${location.pathname === "/order" && s.dn} `}
    >
      <div className={s.freeDelivery}>♥ Безкоштовна доставка по Україні! ♥</div>
      <Layout>
        <div className={s.headerTopLine}>
          <div>
            <button onClick={() => openMenu()} className={s.menuBtn}>
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M3 12H21M3 6H21M3 18H15"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>

              <p>Меню</p>
            </button>
          </div>

          <Link to="/">
            <div className={s.headerLogo}>
              <svg viewBox="0 0 194 28" xmlns="http://www.w3.org/2000/svg">
                <g clipPath="url(#clip0_959_3585)">
                  <path d="M72.5214 0C68.4694 0 65.0707 1.33938 62.3249 4.01764C59.5791 6.69592 58.2062 10.0036 58.2062 13.9406C58.2062 17.9044 59.5791 21.2256 62.3249 23.9039C65.0707 26.5822 68.4694 27.9211 72.5214 27.9211C76.6 27.9211 79.9994 26.5956 82.7184 23.9442C85.4376 21.2392 86.7971 17.9044 86.7971 13.9406C86.7971 10.0036 85.4376 6.69592 82.7184 4.01764C80.0261 1.33938 76.6267 0 72.5214 0ZM153.056 0C149.003 0 145.604 1.33938 142.859 4.01764C140.113 6.69592 138.74 10.0036 138.74 13.9406C138.74 17.9044 140.113 21.2256 142.859 23.9039C145.604 26.5822 149.003 27.9211 153.056 27.9211C157.134 27.9211 160.533 26.5956 163.252 23.9442C165.972 21.2392 167.332 17.9044 167.332 13.9406C167.332 10.0036 165.972 6.69592 163.252 4.01764C160.56 1.33938 157.161 0 153.056 0ZM7.36525 0.40182V7.39229H15.6999C16.1264 7.39229 16.4863 7.55273 16.7795 7.87413C17.0728 8.16873 17.2196 8.55722 17.2196 9.03931C17.2196 9.22678 17.206 9.34726 17.1793 9.40083C17.126 9.77578 16.953 10.0837 16.6597 10.3248C16.3665 10.5658 16.0465 10.6863 15.6999 10.6863H7.36523V16.9538H16.4999C16.953 16.9538 17.3396 17.1277 17.6595 17.4758C17.9794 17.7972 18.1391 18.2122 18.1391 18.7211C18.1391 19.23 17.9794 19.659 17.6595 20.0072C17.3396 20.3553 16.953 20.5293 16.4999 20.5293H7.36523V27.5192H16.6597C19.2988 27.5192 21.5247 26.7563 23.3374 25.2296C25.1235 23.7032 26.0167 21.8012 26.0167 19.5247C26.0167 17.034 24.9638 15.0122 22.8578 13.4588C24.3507 12.0125 25.097 10.2711 25.097 8.23566C25.097 5.98591 24.2173 4.12462 22.4578 2.65157C20.6717 1.15174 18.4857 0.40182 15.8999 0.40182H7.36525ZM28.0561 0.40182V27.5192H35.6134V0.40182H28.0561ZM37.9328 0.40182V27.5192H57.6865V20.5293H45.4901V0.40182H37.9328ZM88.8364 0.40182V27.5192H103.072C105.711 27.5192 107.937 26.7563 109.75 25.2296C111.536 23.7032 112.428 21.8012 112.428 19.5247C112.428 17.034 111.376 15.0122 109.27 13.4588C110.762 12.0125 111.509 10.2711 111.509 8.23566C111.509 5.98591 110.629 4.12462 108.87 2.65157C107.084 1.15174 104.898 0.40182 102.312 0.40182H88.8364ZM114.468 0.40182V27.5192H122.026V19.6854H125.785L130.183 27.5192H138.62L133.302 18.0383C134.688 17.1544 135.768 16.0161 136.54 14.6234C137.341 13.2307 137.741 11.7044 137.741 10.0439C137.741 7.28526 136.742 4.99493 134.742 3.17371C132.769 1.3257 130.303 0.40182 127.344 0.40182H114.468ZM165.892 0.40182L176.768 27.5192H183.046L193.963 0.40182H186.085L179.926 16.5117L173.769 0.40182H165.892ZM72.5214 7.27197C74.3342 7.27197 75.8539 7.91434 77.0802 9.19991C78.3331 10.5123 78.9596 12.0926 78.9596 13.9406C78.9596 15.7886 78.3331 17.369 77.0802 18.6813C75.8539 19.9669 74.3342 20.6094 72.5214 20.6094C70.7087 20.6094 69.176 19.9798 67.923 18.7211C66.6968 17.4623 66.0838 15.869 66.0838 13.9406C66.0838 12.0391 66.6968 10.4587 67.923 9.19991C69.176 7.91434 70.7087 7.27197 72.5214 7.27197ZM153.056 7.27197C154.868 7.27197 156.388 7.91434 157.614 9.19991C158.867 10.5123 159.494 12.0926 159.494 13.9406C159.494 15.7886 158.867 17.369 157.614 18.6813C156.388 19.9669 154.868 20.6094 153.056 20.6094C151.242 20.6094 149.71 19.9798 148.456 18.7211C147.23 17.4623 146.617 15.869 146.617 13.9406C146.617 12.0391 147.23 10.4587 148.456 9.19991C149.71 7.91434 151.242 7.27197 153.056 7.27197ZM96.3937 7.3923H102.112C102.539 7.3923 102.899 7.55275 103.192 7.87413C103.485 8.16875 103.632 8.55724 103.632 9.03931C103.632 9.22679 103.618 9.34727 103.592 9.40084C103.538 9.77581 103.365 10.0838 103.072 10.3248C102.779 10.5659 102.459 10.6863 102.112 10.6863H96.3937V7.3923ZM122.026 7.3923H127.344C128.09 7.3923 128.703 7.64677 129.183 8.15565C129.663 8.63774 129.903 9.26718 129.903 10.0439C129.903 10.8206 129.663 11.463 129.183 11.9718C128.703 12.4807 128.09 12.7352 127.344 12.7352H122.026V7.3923ZM96.3937 16.9538H102.912C103.365 16.9538 103.751 17.1277 104.071 17.476C104.391 17.7973 104.552 18.2123 104.552 18.7211C104.552 19.23 104.391 19.659 104.071 20.0072C103.751 20.3553 103.365 20.5293 102.912 20.5293H96.3937V16.9538Z" />
                  <path d="M1.71213 27.8321C1.2267 27.8321 0.819986 27.6641 0.491992 27.3279C0.163997 26.9885 0 26.57 0 26.0724C0 25.7099 0.0885585 25.3887 0.265675 25.1086C0.436235 24.8284 0.669111 24.6159 0.964306 24.471L1.25458 25.2716C1.10698 25.3507 0.992186 25.4612 0.910188 25.6029C0.824908 25.7412 0.782267 25.8978 0.782267 26.0724C0.782267 26.3295 0.870826 26.5453 1.04794 26.72C1.22178 26.8913 1.44317 26.977 1.71213 26.977C1.97781 26.977 2.20085 26.8913 2.38124 26.72C2.55837 26.5453 2.64692 26.3295 2.64692 26.0724C2.64692 25.8978 2.60592 25.7412 2.52392 25.6029C2.43864 25.4612 2.32221 25.3507 2.17461 25.2716L2.46489 24.471C2.7568 24.6159 2.99131 24.8284 3.16843 25.1086C3.34227 25.392 3.42918 25.7132 3.42918 26.0724C3.42918 26.5766 3.26518 26.9951 2.93719 27.3279C2.60592 27.6641 2.19757 27.8321 1.71213 27.8321ZM1.71213 24.283C1.2267 24.283 0.819986 24.115 0.491992 23.7789C0.163997 23.4395 0 23.021 0 22.5234C0 22.0226 0.163997 21.6057 0.491992 21.2728C0.819986 20.9367 1.2267 20.7687 1.71213 20.7687C2.19757 20.7687 2.60592 20.9367 2.93719 21.2728C3.26518 21.6024 3.42918 22.0193 3.42918 22.5234C3.42918 23.0275 3.26518 23.446 2.93719 23.7789C2.60592 24.115 2.19757 24.283 1.71213 24.283ZM2.64692 22.5234C2.64692 22.2696 2.55837 22.0555 2.38124 21.8808C2.19757 21.7062 1.97453 21.6188 1.71213 21.6188C1.45301 21.6188 1.23326 21.7062 1.05287 21.8808C0.872467 22.0522 0.782267 22.2664 0.782267 22.5234C0.782267 22.7805 0.870826 22.9963 1.04794 23.171C1.22178 23.3422 1.44317 23.428 1.71213 23.428C1.97781 23.428 2.20085 23.3422 2.38124 23.171C2.55837 22.9963 2.64692 22.7805 2.64692 22.5234ZM0.801949 18.139L0.969224 18.9497C0.900348 18.9662 0.844589 19.0107 0.801949 19.0831C0.75603 19.1556 0.733071 19.2413 0.733071 19.3401C0.733071 19.4358 0.75603 19.5181 0.801949 19.5874C0.844589 19.6532 0.898708 19.6861 0.964306 19.6861C1.04303 19.6861 1.11026 19.6285 1.16602 19.5132C1.20538 19.4274 1.25294 19.2874 1.3087 19.0931C1.33494 19.0073 1.34806 18.9629 1.34806 18.9596C1.42022 18.7124 1.52026 18.5015 1.64817 18.3268C1.80561 18.1028 2.04342 17.9907 2.36157 17.9907C2.68628 17.9907 2.9454 18.1077 3.13891 18.3417C3.33244 18.5757 3.42919 18.8771 3.42919 19.2463C3.42919 19.5857 3.34883 19.8806 3.18811 20.131C3.02739 20.3782 2.8142 20.5364 2.54852 20.6056L2.37633 19.7752C2.46816 19.7521 2.5436 19.6928 2.60265 19.5972C2.66169 19.4983 2.6912 19.3798 2.6912 19.2413C2.6912 19.1194 2.66824 19.0173 2.62232 18.9349C2.57312 18.8524 2.5108 18.8113 2.43537 18.8113C2.36976 18.8113 2.31237 18.8542 2.26317 18.9398C2.21397 19.0222 2.16149 19.1556 2.10574 19.3401C2.10245 19.35 2.09916 19.3616 2.09587 19.3747C2.09259 19.388 2.08931 19.3994 2.08605 19.4094C2.01061 19.6532 1.93025 19.8543 1.84497 20.0124C1.67113 20.3255 1.39891 20.4902 1.02827 20.5067C0.723233 20.5067 0.475596 20.4013 0.285361 20.1904C0.0951231 19.9795 3.98151e-06 19.701 3.98151e-06 19.355C3.98151e-06 19.0485 0.0754427 18.7849 0.226321 18.5641C0.380479 18.3334 0.572353 18.1917 0.801949 18.139ZM3.37507 16.8688V17.6744H0.0541229V16.8688L1.95814 15.7862L0.0541229 14.7087V13.903H3.37507V14.7087H1.55469L3.03067 15.5193V16.058L1.55469 16.8688H3.37507ZM0.0541229 13.5174V11.0064H0.806867V12.6969H1.32838V11.2881H2.07621V12.6969H2.62724V10.9817H3.37507V13.5174H0.0541229ZM0.0541229 10.7741V7.9912H0.806867V8.97484H3.37507V9.79537H0.806867V10.7741H0.0541229ZM3.37507 6.88399V7.70451H0.0541229V6.88399H3.37507ZM1.71213 6.54787C1.2267 6.54787 0.819986 6.3798 0.491992 6.04369C0.163997 5.70427 0 5.28578 0 4.78818C0 4.4257 0.0885585 4.10441 0.265675 3.82431C0.436235 3.5442 0.669111 3.33166 0.964306 3.18668L1.25458 3.98744C1.10698 4.06652 0.992186 4.17691 0.910188 4.3186C0.824908 4.457 0.782267 4.61353 0.782267 4.78818C0.782267 5.04521 0.870826 5.26105 1.04794 5.43571C1.22178 5.60707 1.44317 5.69273 1.71213 5.69273C1.97781 5.69273 2.20085 5.60707 2.38124 5.43571C2.55837 5.26105 2.64692 5.04521 2.64692 4.78818C2.64692 4.61353 2.60592 4.457 2.52392 4.3186C2.43864 4.17691 2.32221 4.06652 2.17461 3.98744L2.46489 3.18668C2.7568 3.33166 2.99131 3.5442 3.16843 3.82431C3.34227 4.1077 3.42918 4.42899 3.42918 4.78818C3.42918 5.29236 3.26518 5.71086 2.93719 6.04369C2.60592 6.3798 2.19757 6.54787 1.71213 6.54787ZM0.801949 0.512544L0.969224 1.32319C0.900348 1.33967 0.844589 1.38416 0.801949 1.45665C0.75603 1.52915 0.733071 1.61483 0.733071 1.71369C0.733071 1.80924 0.75603 1.89163 0.801949 1.96082C0.844589 2.02673 0.898708 2.05968 0.964306 2.05968C1.04303 2.05968 1.11026 2.00202 1.16602 1.88668C1.20538 1.801 1.25294 1.66095 1.3087 1.46653C1.33494 1.38085 1.34806 1.33637 1.34806 1.33307C1.42022 1.08593 1.52026 0.875026 1.64817 0.700375C1.80561 0.476296 2.04342 0.364258 2.36157 0.364258C2.68628 0.364258 2.9454 0.481243 3.13891 0.715211C3.33244 0.949175 3.42919 1.25069 3.42919 1.61976C3.42919 1.95917 3.34883 2.2541 3.18811 2.50454C3.02739 2.75169 2.8142 2.90987 2.54852 2.97907L2.37633 2.14866C2.46816 2.1256 2.5436 2.06628 2.60265 1.97071C2.66169 1.87185 2.6912 1.75321 2.6912 1.61481C2.6912 1.4929 2.66824 1.39074 2.62232 1.30836C2.57312 1.22598 2.5108 1.18478 2.43537 1.18478C2.36976 1.18478 2.31237 1.22762 2.26317 1.3133C2.21397 1.39569 2.16149 1.52915 2.10574 1.71369C2.10245 1.72356 2.09916 1.73509 2.09587 1.74827C2.09259 1.76145 2.08931 1.77298 2.08605 1.78287C2.01061 2.02671 1.93025 2.22774 1.84497 2.3859C1.67113 2.69896 1.39891 2.86372 1.02827 2.88021C0.723233 2.88021 0.475596 2.77475 0.285361 2.56385C0.0951231 2.35296 3.98151e-06 2.0745 3.98151e-06 1.72849C3.98151e-06 1.42203 0.0754427 1.15841 0.226321 0.937627C0.380479 0.706957 0.572353 0.565269 0.801949 0.512544Z" />
                </g>
                <defs>
                  <clipPath id="clip0_959_3585">
                    <rect width="194" height="28" fill="white" />
                  </clipPath>
                </defs>
              </svg>
            </div>
          </Link>

          <HeaderUserSettings
            openRegister={openRegister}
            openWishList={openWishList}
            openCart={openCart}
          />
        </div>
        <div className={s.headerBottomLine}>
          <nav>
            <ul className={s.navMenu}>
              {menuTree.map((item) => {
                let modifiedUrl = item.url.replace(/\/$/, "");

                // Обробка виключених категорій
                if (modifiedUrl.endsWith("support")) {
                  modifiedUrl = "support";
                } else if (modifiedUrl.endsWith("brendy")) {
                  modifiedUrl = "brendy";
                } else if (modifiedUrl.endsWith("about")) {
                  modifiedUrl = "about";
                } else if (modifiedUrl.endsWith("podarunkovi-sertyfikaty-20")) {
                  modifiedUrl = "podarunkovi-sertyfikaty-20";
                } else {
                  const supportMatch = modifiedUrl.match(/support\/(.+)$/);
                  if (supportMatch) {
                    modifiedUrl = `support${supportMatch[1]}`;
                  }
                }

                const categoryMatch = modifiedUrl.match(
                  /product-category\/([^/]+)$/
                );

                if (categoryMatch) {
                  modifiedUrl = `/catalog/${categoryMatch[1]}`;
                }

                return (
                  <li className={s.menuItem} key={item.id}>
                    <Link to={modifiedUrl}>{item.title}</Link>
                    {item.children.length > 0 && (
                      <ul className={s.subMenu}>
                        {item.children.map((child) => {
                          let modifiedChildUrl = child.url.replace(/\/$/, ""); // Видаляємо слеш у кінці

                          // Остання частина URL
                          const lastPart = modifiedChildUrl.split("/").pop();

                          // Обробка виключених категорій для дочірніх елементів
                          if (modifiedChildUrl.includes("support")) {
                            modifiedChildUrl = modifiedChildUrl.endsWith(
                              "support"
                            )
                              ? "support"
                              : `support#${
                                  modifiedChildUrl.split("support/")[1]
                                }`;
                          } else {
                            // Перевірка для product-category/{parent}/{child} у дочірніх елементах
                            const childCategoryMatch = modifiedChildUrl.match(
                              /product-category\/([^/]+)\/([^/]+)$/
                            );

                            if (childCategoryMatch) {
                              modifiedChildUrl = `/catalog/${childCategoryMatch[1]}/${lastPart}`;
                            }
                          }

                          return (
                            <li key={child.id}>
                              <Link to={modifiedChildUrl}>{child.title}</Link>
                            </li>
                          );
                        })}
                      </ul>
                    )}
                  </li>
                );
              })}
            </ul>
          </nav>
        </div>
      </Layout>
    </header>
  );
};
